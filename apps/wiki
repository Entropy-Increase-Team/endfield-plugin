import { rulePrefix } from '../utils/common.js'
import common from '../../../lib/common/common.js'
import EndfieldRequest from '../model/endfieldReq.js'
import setting from '../utils/setting.js'

/** Wiki 游戏百科主分类 ID（干员/武器/装备/物品等） */
const WIKI_MAIN_TYPE_GAME = '1'
/** 子分类 ID 对应展示名 */
const WIKI_SUB_LABEL = { '1': '干员', '2': '武器', '3': '威胁', '4': '装备', '5': '设备', '6': '物品', '7': '武器基质', '8': '任务', '9': '活动' }

export class EndfieldWiki extends plugin {
  constructor() {
    super({
      name: '[endfield-plugin]Wiki查询',
      dsc: '终末地Wiki数据查询（:wiki xxx / :wikixxx）',
      event: 'message',
      priority: 50,
      rule: [
        { reg: `^${rulePrefix}wiki\\s*(.+)$`, fnc: 'queryWiki' }
      ]
    })

    this.common_setting = setting.getConfig('common')
  }

  /** 从消息中取出查询关键词（:wiki xxx 或 :wikixxx 后面的部分） */
  getWikiQuery() {
    const msg = (this.e.msg || '').trim()
    const mode = Number(this.common_setting?.prefix_mode) || 1
    const prefix = mode === 2 ? /^#(终末地|zmd)?\s*/ : /^[:：]\s*/
    const afterPrefix = msg.replace(prefix, '').replace(/^wiki\s*/i, '')
    return afterPrefix.trim() || ''
  }

  /** 在条目列表中按名称精确/模糊匹配 */
  findByName(items, name) {
    if (!Array.isArray(items) || !name) return null
    const n = String(name).trim()
    const exact = items.find((item) => (item.name || '') === n)
    if (exact) return exact
    const fuzzy = items.find((item) => (item.name || '').includes(n) || n.includes(item.name || ''))
    return fuzzy || items[0] || null
  }

  /** 统一 Wiki 查询：:wiki xxx / :wikixxx，先拉干员列表再取详情 */
  async queryWiki() {
    const name = this.getWikiQuery()
    if (!name) {
      await this.reply('请输入查询内容，例：:wiki 莱万汀 或 :wikixxx')
      return true
    }

    const commonConfig = setting.getConfig('common') || {}
    if (!commonConfig.api_key || String(commonConfig.api_key).trim() === '') {
      await this.reply('Wiki 查询需要配置 api_key，请在 config/common.yaml 中填写（终末地协议终端获取）')
      return true
    }

    const req = new EndfieldRequest(0, '', '')
    // 干员查询所用接口：
    // ① GET /api/wiki/items?main_type_id=1&sub_type_id=1 获取干员列表（data.items[].item_id）
    // ② GET /api/wiki/items/:id 取详情，id 为列表中匹配条目的 item_id
    const listRes = await req.getWikiData('wiki_items', {
      main_type_id: WIKI_MAIN_TYPE_GAME,
      sub_type_id: '1',
      page: 1,
      page_size: 100
    })

    if (!listRes || listRes.code !== 0) {
      logger.error(`[终末地Wiki] 干员列表失败: ${JSON.stringify(listRes)}`)
      await this.reply(`查询「${name}」失败，请稍后重试`)
      return true
    }

    const items = listRes.data?.items || []
    const item = this.findByName(items, name)
    if (!item) {
      await this.reply(`未找到与「${name}」相关的干员条目`)
      return true
    }

    const detailRes = await req.getWikiData('wiki_item_detail', { id: item.item_id })
    if (!detailRes || detailRes.code !== 0 || !detailRes.data) {
      await this.reply(`未获取到「${item.name || item.item_id}」的百科详情`)
      return true
    }

    const data = detailRes.data
    const subTypeId = String(data.sub_type_id ?? data.subTypeId ?? '')
    const typeLabel = WIKI_SUB_LABEL[subTypeId] || '百科'
    let text = this.formatItemDetail(data, typeLabel)
    text = this.dedupLines(text)
    const cover = data.cover
    const seg = global.segment || (await import('oicq')).segment

    // 内容按长度分段，用合并转发发送，避免刷屏
    const maxSegmentLen = 1500
    const segments = this.splitContent(text, maxSegmentLen)
    if (segments.length === 0) segments.push('暂无正文')

    const forwardParts = []
    const firstContent = segments[0] || text
    if (cover && seg?.image) {
      try {
        forwardParts.push([firstContent, seg.image(cover)])
      } catch (e) {
        forwardParts.push([firstContent])
      }
    } else {
      forwardParts.push([firstContent])
    }
    for (let i = 1; i < segments.length; i++) {
      forwardParts.push([segments[i]])
    }
    const forwardMsg = common.makeForwardMsg(this.e, forwardParts, `终末地Wiki-${typeLabel}`)
    await this.e.reply(forwardMsg)
    return true
  }

  /** 合并连续重复行，减少重复内容（如多处相同的「基础数据」「技能数据」表头等） */
  dedupLines(text) {
    if (!text || typeof text !== 'string') return text
    const lines = text.split('\n')
    const out = []
    let prev = ''
    for (const line of lines) {
      const trimmed = line.trim()
      if (trimmed === '' && prev === '') continue
      if (trimmed === prev) continue
      prev = trimmed
      out.push(line)
    }
    return out.join('\n').replace(/\n{3,}/g, '\n\n')
  }

  /** 格式化 Wiki 条目详情：标题 + caption + 正文（document_map 渲染） */
  formatItemDetail(data, typeLabel) {
    let out = `【${typeLabel}】${data.name || '未知'}\n`
    if (Array.isArray(data.caption) && data.caption.length > 0) {
      const cap = this.renderCaption(data.caption)
      if (cap) out += cap + '\n'
    }
    if (data.content?.document_map || data.content?.documentMap) {
      const body = this.renderWikiContent(data.content)
      if (body) out += body
    }
    if (!out.trim()) out += '暂无正文内容\n'
    return out.trim()
  }

  renderCaption(caption) {
    if (!Array.isArray(caption)) return ''
    return caption
      .map((c) => (c?.kind === 'text' && c?.text?.text ? c.text.text : ''))
      .filter(Boolean)
      .join(' ')
  }

  /** 渲染时不展示的章节标题（API 结构键，非文案硬编码） */
  static EXCLUDED_CHAPTER_TITLES = ['干员档案', '特别提醒']

  /**
   * 根据 content 结构收集需排除的文档 ID（上述章节下 widgets 对应的 document）。
   * 通过 chapter_group → title 匹配 → widgets → widget_common_map 的 tab_data_map.content。
   */
  getExcludedDocumentIds(content) {
    const excluded = new Set()
    const chapterGroup = content?.chapter_group || content?.chapterGroup || []
    const widgetMap = content?.widget_common_map || content?.widgetCommonMap || {}
    const excludeTitles = new Set(EndfieldWiki.EXCLUDED_CHAPTER_TITLES)
    for (const ch of chapterGroup) {
      const title = ch?.title || ''
      if (!excludeTitles.has(title)) continue
      const widgets = ch?.widgets || []
      for (const w of widgets) {
        const wid = w?.id
        if (!wid) continue
        const widgetData = widgetMap[wid]
        if (!widgetData) continue
        const tabDataMap = widgetData.tab_data_map || widgetData.tabDataMap || {}
        for (const key of Object.keys(tabDataMap)) {
          const c = tabDataMap[key]?.content
          if (c) excluded.add(c)
        }
      }
    }
    return excluded
  }

  /** 将 content.document_map 渲染为纯文本（text/table/list/分割线），兼容 documentMap / blockIds / blockMap；排除干员档案章节 */
  renderWikiContent(content) {
    const docMap = content?.document_map || content?.documentMap || {}
    if (!docMap || typeof docMap !== 'object') return ''
    const excludedDocIds = this.getExcludedDocumentIds(content)
    const lines = []
    for (const docId of Object.keys(docMap)) {
      if (excludedDocIds.has(docId)) continue
      const doc = docMap[docId]
      const blockIds = doc.block_ids || doc.blockIds || []
      const blockMap = doc.block_map || doc.blockMap || {}
      for (const bid of blockIds) {
        const block = blockMap[bid]
        if (!block) continue
        const line = this.renderBlock(block, blockMap)
        if (line) lines.push(line)
      }
    }
    const raw = lines.join('\n').replace(/\n{3,}/g, '\n\n')
    return raw
  }

  renderBlock(block, blockMap) {
    if (!block) return ''
    switch (block.kind) {
      case 'text': {
        const t = block.text
        const elements = t?.inline_elements || t?.inlineElements || []
        if (!Array.isArray(elements) || elements.length === 0) return ''
        return elements
          .map((el) => {
            if (el.kind === 'text') {
              if (typeof el.text === 'string') return el.text
              if (el.text?.text != null) return el.text.text
              return ''
            }
            if (el.kind === 'entry' && el.entry?.name) return el.entry.name
            if (el.kind === 'link' && el.link?.text) return el.link.text
            return ''
          })
          .filter(Boolean)
          .join('')
      }
      case 'table': {
        const table = block.table
        const cellMap = table?.cell_map || table?.cellMap || {}
        if (!Object.keys(cellMap).length) return ''
        const cells = []
        for (const cid of Object.keys(cellMap)) {
          const cell = cellMap[cid]
          const childIds = cell.child_ids || cell.childIds || []
          for (const childId of childIds) {
            const child = blockMap[childId]
            if (child) cells.push(this.renderBlock(child, blockMap))
          }
        }
        return cells.filter(Boolean).join(' | ')
      }
      case 'list': {
        const list = block.list
        const itemMap = list?.item_map || list?.itemMap || {}
        const itemIds = list?.item_ids || list?.itemIds || []
        if (!Object.keys(itemMap).length) return ''
        const items = []
        for (const iid of itemIds) {
          const item = itemMap[iid]
          const childIds = item?.child_ids || item?.childIds || []
          for (const cid of childIds) {
            const c = blockMap[cid]
            if (c) items.push(this.renderBlock(c, blockMap))
          }
        }
        return items.filter(Boolean).join('；')
      }
      case 'horizontalLine':
        return '────────────'
      default:
        return ''
    }
  }

  splitContent(content, maxLength = 2000) {
    if (!content) return []
    const messages = []
    let currentIndex = 0
    while (currentIndex < content.length) {
      let segment = content.slice(currentIndex, currentIndex + maxLength)
      if (currentIndex + maxLength < content.length) {
        const lastPunctuation = Math.max(
          segment.lastIndexOf('。'),
          segment.lastIndexOf('！'),
          segment.lastIndexOf('？'),
          segment.lastIndexOf('\n')
        )
        if (lastPunctuation > maxLength * 0.5) {
          segment = segment.slice(0, lastPunctuation + 1)
          currentIndex += lastPunctuation + 1
        } else {
          currentIndex += maxLength
        }
      } else {
        currentIndex = content.length
      }
      if (segment.trim()) messages.push(segment)
    }
    return messages
  }
}
